<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/jquery.min.js"></script>
    <style>
        body {
            background-color: ivory;
            padding:10px;
        }

        #canvas {
            border:1px solid red;
        }
    </style>
</head>
<body>
    <p>Test produce box2d rectangle <button id="start">start</button></p>
    <canvas id="canvas" width=800 height=400></canvas>
    <script src="js/DraggableImage.js"></script>
    <script src="js/Box2d.min.js"></script>
    <script>

        // Set scale factor from pixel to meters in box2d
        var SCALE = 30;

        var   b2Vec2 = Box2D.Common.Math.b2Vec2
                , b2BodyDef = Box2D.Dynamics.b2BodyDef
                , b2Body = Box2D.Dynamics.b2Body
                , b2FixtureDef = Box2D.Dynamics.b2FixtureDef
                , b2Fixture = Box2D.Dynamics.b2Fixture
                , b2World = Box2D.Dynamics.b2World
                , b2MassData = Box2D.Collision.Shapes.b2MassData
                , b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
                , b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
                , b2DebugDraw = Box2D.Dynamics.b2DebugDraw
                ;

        var DYNAMIC_DEF_EXAMPLE = {
            fixDef: new b2FixtureDef,
            bodyDef: new b2BodyDef
        };
        DYNAMIC_DEF_EXAMPLE.fixDef.density = 1.0;
        DYNAMIC_DEF_EXAMPLE.fixDef.friction = 0.5;
        DYNAMIC_DEF_EXAMPLE.fixDef.restitution = 0.2;
        DYNAMIC_DEF_EXAMPLE.bodyDef.type = b2Body.b2_dynamicBody;

        var STATIC_DEF_EXAMPLE = {
            fixDef: new b2FixtureDef,
            bodyDef: new b2BodyDef
        };
        STATIC_DEF_EXAMPLE.fixDef.density = 1.0;
        STATIC_DEF_EXAMPLE.fixDef.friction = 0.5;
        STATIC_DEF_EXAMPLE.fixDef.restitution = 0.2;
        STATIC_DEF_EXAMPLE.bodyDef.type = b2Body.b2_staticBody;

        var orangeSquare = new Draggable(DYNAMIC_DEF_EXAMPLE,{
            imageSrc: 'img/orange.jpg',
            imageX: 620,
            imageY: 20,
            imageWidth: 50,
            imageHeight: 50
        });
        var orangeSquare2 = new Draggable(DYNAMIC_DEF_EXAMPLE,{
            imageSrc: 'img/orange.jpg',
            imageX: 700,
            imageY: 20,
            imageWidth: 50,
            imageHeight: 50
        });
        var blueSquare = new Draggable(STATIC_DEF_EXAMPLE,{
            imageSrc: 'img/blue.jpg',
            imageX: 620,
            imageY: 100,
            imageWidth: 50,
            imageHeight: 50
        });
        var blueSquare2 = new Draggable(STATIC_DEF_EXAMPLE,{
            imageSrc: 'img/blue.jpg',
            imageX: 700,
            imageY: 100,
            imageWidth: 50,
            imageHeight: 50
        });
        draggableImageArray.push(orangeSquare);
        draggableImageArray.push(orangeSquare2);
        draggableImageArray.push(blueSquare);
        draggableImageArray.push(blueSquare2);

        window.requestAnimFrame = (function(){
            return window.requestAnimationFrame       ||
                    window.webkitRequestAnimationFrame ||
                    window.mozRequestAnimationFrame    ||
                    window.oRequestAnimationFrame      ||
                    window.msRequestAnimationFrame     ||
                    function(/* function */ callback, /* DOMElement */ element){
                        window.setTimeout(callback, 1000 / 60);
                    };
        })();

        var world;

        function init() {


            world = new b2World(
                    new b2Vec2(0, 10)    //gravity
                    ,  true                 //allow sleep
            );

            var fixDef = new b2FixtureDef;
            fixDef.density = 1.0;
            fixDef.friction = 0.5;
            fixDef.restitution = 0.2;

            var bodyDef = new b2BodyDef;

            //create ground
            bodyDef.type = b2Body.b2_staticBody;

            // positions the center of the object (not upper left!)
            bodyDef.position.x = canvas.width / 2 / SCALE;
            bodyDef.position.y = canvas.height / SCALE;

            fixDef.shape = new b2PolygonShape;

            // half width, half height. eg actual height here is 1 unit
            fixDef.shape.SetAsBox((600 / SCALE) / 2, (10/SCALE) / 2);
            world.CreateBody(bodyDef).CreateFixture(fixDef);

            //create some objects
            for (var i = 0; i < draggableImageArray.length; i++) {
                var dg = draggableImageArray[i];
                createBox2dObjectFromDraggable(dg);
            }

            //setup debug draw
            var debugDraw = new b2DebugDraw();
            debugDraw.SetSprite(ctx);
            debugDraw.SetDrawScale(SCALE);
            debugDraw.SetFillAlpha(0.3);
            debugDraw.SetLineThickness(1.0);
            debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
            world.SetDebugDraw(debugDraw);

        }; // init()

        function createBox2dObjectFromDraggable(draggable) {
            var fixDef = draggable.b2FixtureDef;
            fixDef.shape = new b2PolygonShape;
            fixDef.shape.SetAsBox(draggable.imageWidth * 0.5 / SCALE, draggable.imageHeight * 0.5 / SCALE);

            var bodyDef = draggable.b2BodyDef;
            bodyDef.position.x = draggable.imageX / SCALE;
            bodyDef.position.y = draggable.imageY / SCALE;
            world.CreateBody(bodyDef).CreateFixture(fixDef);
        };

        function update() {
            world.Step(
                    1 / 60   //frame-rate
                    ,  10       //velocity iterations
                    ,  10       //position iterations
            );
            world.DrawDebugData();
            world.ClearForces();

            requestAnimFrame(update);
        }; // update()

        $('#start').click(function(){
            init();
            requestAnimFrame(update);
        });
    </script>
</body>
</html>